<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Googleã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ“ãƒ¥ãƒ¼ãƒ¯ãƒ¼</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script>
        // Tailwind CDNè­¦å‘Šã‚’éè¡¨ç¤º
        window.process = { env: { NODE_ENV: 'production' } };
        
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        primary: '#4F46E5',
                        secondary: '#10B981',
                    }
                }
            }
        }
    </script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
        }
        
        /* ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #c7c7c7;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        /* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚³ãƒ³ãƒ†ãƒŠ */
        .calendar-container {
            width: 100%;
            height: 100vh;
            overflow: hidden;
        }

        /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º */
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4F46E5;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ã‚¤ãƒ™ãƒ³ãƒˆã‚«ãƒ¼ãƒ‰ */
        .event-card {
            border-left: 4px solid;
            transition: all 0.2s ease;
        }
        .event-card:hover {
            transform: translateX(2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        /* æœˆè¡¨ç¤ºã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, minmax(0, 1fr));
            gap: 0;
            width: 100%;
            border: 1px solid #e5e7eb;
        }

        .calendar-day {
            background: white;
            min-height: 100px;
            max-width: 100%;
            padding: 0;
            position: relative;
            overflow: visible;
            border-right: 1px solid #e5e7eb;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .calendar-day:nth-child(7n) {
            border-right: none;
        }

        .calendar-day.other-month {
            background: #f9fafb;
            color: #9ca3af;
        }

        .calendar-day.today {
            background: #eef2ff;
        }

        .day-number {
            font-weight: 600;
            padding: 8px 8px 4px 8px;
        }

        .day-events {
            font-size: 0.75rem;
            width: 100%;
            overflow: visible;
            padding-bottom: 4px;
        }

        .day-event {
            padding: 2px 4px;
            margin: 2px 4px;
            border-radius: 2px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            cursor: pointer;
            max-width: calc(100% - 8px);
            display: block;
        }

        .day-event:hover {
            opacity: 0.8;
        }

        .event-spanning {
            font-size: 0.7rem;
            padding: 2px 6px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            position: absolute;
            height: 22px;
            line-height: 18px;
            z-index: 10;
            border-radius: 3px;
            margin: 0;
            max-width: none;
        }
        
        .event-placeholder {
            height: 26px;
            margin: 2px 0;
            visibility: hidden;
        }

        /* å›è»¢ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .spinning {
            animation: spin 1s linear infinite;
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.2s;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: white;
            padding: 24px;
            border-radius: 8px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            animation: slideIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
    </style>
</head>
<body>
    <div id="app" class="calendar-container">
        <div class="flex items-center justify-center h-full">
            <div class="text-center">
                <div class="loading-spinner mx-auto mb-4"></div>
                <p class="text-gray-600">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</p>
            </div>
        </div>
    </div>

    <div id="exment-calendar-config" style="display:none;" data-config='{"calendars":[],"syncInterval":15}'></div>
    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«è¨­å®šï¼ˆPHPã‹ã‚‰æ³¨å…¥ã•ã‚Œã‚‹ï¼‰
        let config = { calendars: [], syncInterval: 15 };
        try {
            const configDiv = document.getElementById('exment-calendar-config');
            if (configDiv) {
                const configAttr = configDiv.getAttribute('data-config');
                if (configAttr) {
                    console.log('Config attribute found, length:', configAttr.length);
                    config = JSON.parse(configAttr);
                    console.log('Config loaded successfully:', config);
                }
            }
        } catch (e) {
            console.error('è¨­å®šã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:', e);
            console.error('Config attribute was:', document.getElementById('exment-calendar-config')?.getAttribute('data-config'));
            config = window.exmentGoogleCalendarConfig || { calendars: [], syncInterval: 15 };
        }

        // iCalãƒ‘ãƒ¼ã‚µãƒ¼
        class ICalParser {
            static parse(icalData) {
                const events = [];
                const lines = icalData.split(/\r?\n/);
                let currentEvent = null;

                for (let i = 0; i < lines.length; i++) {
                    let line = lines[i].trim();

                    // è¤‡æ•°è¡Œã®ç¶™ç¶šã‚’å‡¦ç†
                    while (i + 1 < lines.length && lines[i + 1].match(/^[ \t]/)) {
                        i++;
                        line += lines[i].trim();
                    }

                    if (line === 'BEGIN:VEVENT') {
                        currentEvent = {};
                    } else if (line === 'END:VEVENT' && currentEvent) {
                        if (currentEvent.start && currentEvent.summary) {
                            events.push(currentEvent);
                        }
                        currentEvent = null;
                    } else if (currentEvent) {
                        const colonIndex = line.indexOf(':');
                        if (colonIndex > 0) {
                            const key = line.substring(0, colonIndex);
                            const value = line.substring(colonIndex + 1);

                            if (key.startsWith('DTSTART')) {
                                currentEvent.start = this.parseDate(value);
                                currentEvent.allDay = !value.includes('T');
                            } else if (key.startsWith('DTEND')) {
                                currentEvent.end = this.parseDate(value);
                            } else if (key === 'SUMMARY') {
                                currentEvent.summary = value;
                            } else if (key === 'DESCRIPTION') {
                                currentEvent.description = value;
                            } else if (key === 'LOCATION') {
                                currentEvent.location = value;
                            }
                        }
                    }
                }

                return events;
            }

            static parseDate(dateString) {
                // YYYYMMDD or YYYYMMDDTHHMMSSå½¢å¼
                const year = parseInt(dateString.substr(0, 4));
                const month = parseInt(dateString.substr(4, 2)) - 1;
                const day = parseInt(dateString.substr(6, 2));

                if (dateString.includes('T')) {
                    const hour = parseInt(dateString.substr(9, 2));
                    const minute = parseInt(dateString.substr(11, 2));
                    const second = parseInt(dateString.substr(13, 2));
                    return new Date(Date.UTC(year, month, day, hour, minute, second));
                }

                return new Date(year, month, day);
            }
        }

        // HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—é–¢æ•°ï¼ˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒªãƒ†ãƒ©ãƒ«ç”¨ï¼‰
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML
                .replace(/`/g, '&#96;')
                .replace(/\$/g, '&#36;')
                .replace(/\\/g, '&#92;');
        }

        // JSON ã‚’ HTML å±æ€§ç”¨ã«å®‰å…¨ã«ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
        function escapeJsonForAttribute(obj) {
            const json = JSON.stringify(obj);
            return json
                .replace(/&/g, '&amp;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/\n/g, '&#10;')
                .replace(/\r/g, '&#13;')
                .replace(/`/g, '&#96;')
                .replace(/\$/g, '&#36;');
        }

        // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³
        class CalendarApp {
            constructor() {
                this.events = [];
                this.currentDate = new Date();
                this.view = 'month'; // month, week, list
                this.activeCalendars = new Set(config.calendars.map(cal => cal.name));
                this.init();
            }

            async init() {
                await this.loadEvents();
                this.render();
                this.startAutoSync();
            }

            async loadEvents() {
                this.events = [];
                
                for (const calendar of config.calendars) {
                    try {
                        const proxyUrl = `${config.proxyUrl}?url=${encodeURIComponent(calendar.url)}`;
                        const response = await fetch(proxyUrl);
                        const icalData = await response.text();
                        const events = ICalParser.parse(icalData);
                        
                        events.forEach(event => {
                            event.calendar = calendar.name;
                            event.color = calendar.color;
                            this.events.push(event);
                        });
                    } catch (error) {
                        console.error(`ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ ${calendar.name} ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—:`, error);
                    }
                }

                this.events.sort((a, b) => a.start - b.start);
            }

            startAutoSync() {
                setInterval(() => {
                    this.loadEvents().then(() => this.render());
                }, config.syncInterval * 60 * 1000);
            }

            render() {
                const app = document.getElementById('app');
                
                app.innerHTML = `
                    <div class="h-full flex flex-col">
                        ${this.renderHeader()}
                        ${this.renderCalendar()}
                    </div>
                `;

                this.attachEventListeners();
            }

            renderHeader() {
                const monthNames = ['1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ', '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ'];
                const currentMonth = monthNames[this.currentDate.getMonth()];
                const currentYear = this.currentDate.getFullYear();

                // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼é¸æŠãƒœã‚¿ãƒ³
                let calendarButtons = '';
                config.calendars.forEach(cal => {
                    const isActive = this.activeCalendars ? this.activeCalendars.has(cal.name) : true;
                    calendarButtons += `
                        <button class="calendar-toggle px-3 py-1 rounded-full text-sm transition ${isActive ? 'opacity-100' : 'opacity-50'}" 
                                style="background-color: ${cal.color}20; color: ${cal.color}; border: 2px solid ${cal.color};" 
                                data-calendar="${cal.name}">
                            ${isActive ? 'âœ“' : ''} ${cal.name}
                        </button>
                    `;
                });

                return `
                    <div class="bg-white border-b px-6 py-4">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center space-x-4">
                                <h1 class="text-2xl font-bold text-gray-800">${currentYear}å¹´ ${currentMonth}</h1>
                                <button id="sync-btn" class="px-4 py-2 bg-secondary text-white rounded-lg hover:bg-opacity-90 transition flex items-center space-x-2">
                                    <svg id="sync-icon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                    </svg>
                                    <span>åŒæœŸ</span>
                                </button>
                            </div>
                            <div class="flex items-center space-x-2">
                                <button id="prev-btn" class="p-2 hover:bg-gray-100 rounded-lg transition">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                                    </svg>
                                </button>
                                <button id="today-btn" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-opacity-90 transition">ä»Šæ—¥</button>
                                <button id="next-btn" class="p-2 hover:bg-gray-100 rounded-lg transition">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2 flex-wrap">
                            ${calendarButtons}
                        </div>
                    </div>
                `;
            }

            renderCalendar() {
                const year = this.currentDate.getFullYear();
                const month = this.currentDate.getMonth();
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const startDate = new Date(firstDay);
                startDate.setDate(startDate.getDate() - startDate.getDay());

                const days = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
                
                // ã‚°ãƒªãƒƒãƒ‰ã‚³ãƒ³ãƒ†ãƒŠã‚’ä½œæˆ
                const calendarDiv = document.createElement('div');
                calendarDiv.className = 'flex-1 overflow-auto p-6';
                
                const gridDiv = document.createElement('div');
                gridDiv.className = 'calendar-grid';
                gridDiv.style.position = 'relative';

                // æ›œæ—¥ãƒ˜ãƒƒãƒ€ãƒ¼
                days.forEach(day => {
                    const headerDiv = document.createElement('div');
                    headerDiv.className = 'bg-gray-100 p-2 text-center font-semibold';
                    headerDiv.textContent = day;
                    gridDiv.appendChild(headerDiv);
                });

                // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æ—¥ä»˜
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                // ã‚¹ãƒ­ãƒƒãƒˆç®¡ç†ç”¨ (æœ€å¤§5ã‚¹ãƒ­ãƒƒãƒˆ)
                let currentSlots = [null, null, null, null, null];

                for (let i = 0; i < 42; i++) {
                    const currentDay = new Date(startDate);
                    currentDay.setDate(currentDay.getDate() + i);
                    
                    const isOtherMonth = currentDay.getMonth() !== month;
                    const isToday = currentDay.getTime() === today.getTime();
                    
                    // ãã®æ—¥ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’å–å¾—
                    const dayEvents = this.events.filter(event => {
                        if (!this.activeCalendars.has(event.calendar)) return false;
                        const eventStart = new Date(event.start);
                        eventStart.setHours(0, 0, 0, 0);
                        const eventEnd = event.end ? new Date(event.end) : new Date(event.start);
                        eventEnd.setHours(0, 0, 0, 0);
                        
                        // é–‹å§‹æ—¥ãŒä»Šæ—¥ã€ã¾ãŸã¯æœŸé–“å†… (çµ‚äº†æ—¥ã¯å«ã¾ãªã„)
                        return (eventStart.getTime() === currentDay.getTime()) ||
                               (eventStart.getTime() < currentDay.getTime() && eventEnd.getTime() > currentDay.getTime());
                    });

                    // è¤‡æ•°æ—¥ã‚¤ãƒ™ãƒ³ãƒˆã¨å˜æ—¥ã‚¤ãƒ™ãƒ³ãƒˆã«åˆ†é›¢
                    const multiDayEvents = [];
                    const singleDayEvents = [];

                    dayEvents.forEach(event => {
                        const eventStart = new Date(event.start);
                        eventStart.setHours(0, 0, 0, 0);
                        const eventEnd = event.end ? new Date(event.end) : new Date(event.start);
                        eventEnd.setHours(0, 0, 0, 0);
                        
                        if (eventEnd.getTime() > eventStart.getTime()) {
                            multiDayEvents.push(event);
                        } else {
                            singleDayEvents.push(event);
                        }
                    });

                    // 1. ã‚¹ãƒ­ãƒƒãƒˆã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ— (çµ‚äº†ã—ãŸã‚¤ãƒ™ãƒ³ãƒˆã‚’å‰Šé™¤)
                    currentSlots = currentSlots.map(event => {
                        if (!event) return null;
                        const eventEnd = event.end ? new Date(event.end) : new Date(event.start);
                        eventEnd.setHours(0, 0, 0, 0);
                        // ä»Šæ—¥ã¾ã ç¶šã„ã¦ã„ã‚‹ã‹ï¼Ÿ (çµ‚äº†æ—¥ãŒä»Šæ—¥ã‚ˆã‚Šå¾Œãªã‚‰ç¶šã)
                        if (eventEnd.getTime() > currentDay.getTime()) {
                            return event;
                        }
                        return null;
                    });

                    // 2. æ–°ã—ã„è¤‡æ•°æ—¥ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç©ºãã‚¹ãƒ­ãƒƒãƒˆã«å‰²ã‚Šå½“ã¦
                    const startingMultiDayEvents = multiDayEvents.filter(event => {
                        const eventStart = new Date(event.start);
                        eventStart.setHours(0, 0, 0, 0);
                        
                        // é–‹å§‹æ—¥ãŒä»Šæ—¥ã®å ´åˆ
                        if (eventStart.getTime() === currentDay.getTime()) return true;
                        
                        // ã¾ãŸã¯ã€ã‚°ãƒªãƒƒãƒ‰ã®æœ€åˆã®æ—¥(i===0)ã§ã€ã‹ã¤æ—¢ã«é–‹å§‹ã—ã¦ã„ã‚‹å ´åˆï¼ˆå‰æœˆã‹ã‚‰ã®ç¶™ç¶šãªã©ï¼‰
                        if (i === 0 && eventStart.getTime() < currentDay.getTime()) return true;
                        
                        return false;
                    });
                    
                    // ã‚½ãƒ¼ãƒˆ (æœŸé–“ãŒé•·ã„é †ã€é–‹å§‹æ—¥æ™‚é †)
                    startingMultiDayEvents.sort((a, b) => {
                        const durationA = (a.end ? new Date(a.end).getTime() : new Date(a.start).getTime()) - new Date(a.start).getTime();
                        const durationB = (b.end ? new Date(b.end).getTime() : new Date(b.start).getTime()) - new Date(b.start).getTime();
                        
                        // æœŸé–“ãŒé•·ã„é †
                        if (durationA !== durationB) {
                            return durationB - durationA;
                        }
                        // é–‹å§‹æ—¥æ™‚é †
                        return new Date(a.start).getTime() - new Date(b.start).getTime();
                    });

                    startingMultiDayEvents.forEach(event => {
                        // æ—¢ã«ã‚¹ãƒ­ãƒƒãƒˆã«ã‚ã‚‹ã‹ç¢ºèªï¼ˆé‡è¤‡é˜²æ­¢ï¼‰
                        if (currentSlots.includes(event)) return;

                        const emptyIndex = currentSlots.indexOf(null);
                        if (emptyIndex !== -1) {
                            currentSlots[emptyIndex] = event;
                        }
                    });

                    // DOMç”Ÿæˆ
                    let dayClass = 'calendar-day';
                    if (isOtherMonth) dayClass += ' other-month';
                    if (isToday) dayClass += ' today';

                    const dayDiv = document.createElement('div');
                    dayDiv.className = dayClass;
                    
                    const dayNumber = document.createElement('div');
                    dayNumber.className = 'day-number';
                    dayNumber.textContent = currentDay.getDate();
                    dayDiv.appendChild(dayNumber);
                    
                    const dayEventsDiv = document.createElement('div');
                    dayEventsDiv.className = 'day-events';
                    dayEventsDiv.style.position = 'relative';

                    // 3. ã‚¹ãƒ­ãƒƒãƒˆã®æç”»
                    // æœ€å¤§ã‚¹ãƒ­ãƒƒãƒˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ç‰¹å®š
                    let maxSlot = -1;
                    for (let s = 4; s >= 0; s--) {
                        if (currentSlots[s]) {
                            maxSlot = s;
                            break;
                        }
                    }

                    for (let s = 0; s <= maxSlot; s++) {
                        const event = currentSlots[s];
                        
                        // ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ (é«˜ã•ç¢ºä¿)
                        const placeholder = document.createElement('div');
                        placeholder.style.height = '24px';
                        placeholder.style.marginBottom = '2px';
                        placeholder.style.visibility = 'hidden'; // å¸¸ã«éè¡¨ç¤ºï¼ˆã‚¹ãƒšãƒ¼ã‚¹ç¢ºä¿ã®ã¿ï¼‰
                        dayEventsDiv.appendChild(placeholder);

                        if (event) {
                            const eventStart = new Date(event.start);
                            eventStart.setHours(0, 0, 0, 0);
                            const eventEnd = event.end ? new Date(event.end) : new Date(event.start);
                            eventEnd.setHours(0, 0, 0, 0);

                            const isStart = eventStart.getTime() === currentDay.getTime();
                            const dayOfWeek = currentDay.getDay();
                            const isWeekStart = dayOfWeek === 0;
                            const isWeekEnd = dayOfWeek === 6;

                            // ãƒãƒ¼ã‚’æç”» (å„æ—¥ã«ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã¨ã—ã¦æç”»)
                            const eventDiv = document.createElement('div');
                            let className = 'day-event event-spanning';
                            
                            // ç¶™ç¶šçŠ¶æ…‹ã®åˆ¤å®š
                            const nextDay = new Date(currentDay);
                            nextDay.setDate(nextDay.getDate() + 1);

                            const continuesLeft = !isStart && !isWeekStart;
                            const continuesRight = (eventEnd.getTime() > nextDay.getTime()) && !isWeekEnd;

                            // ã‚¹ã‚¿ã‚¤ãƒ«èª¿æ•´
                            let left = 0;
                            let widthAdd = 0;
                            
                            // ãƒãƒ¼ã‚¸ãƒ³ã¨æœ€å¤§å¹…ã®ãƒªã‚»ãƒƒãƒˆã¯CSSã§è¡Œã£ã¦ã„ã‚‹ãŒã€å¿µã®ãŸã‚ã‚¹ã‚¿ã‚¤ãƒ«ã§ã‚‚æ˜ç¤º
                            eventDiv.style.margin = '0';
                            eventDiv.style.maxWidth = 'none';

                            if (continuesLeft) {
                                eventDiv.style.borderTopLeftRadius = '0';
                                eventDiv.style.borderBottomLeftRadius = '0';
                                left -= 1; // å·¦å¢ƒç•Œç·šã‚’è¦†ã†
                                widthAdd += 1;
                            }

                            if (continuesRight) {
                                eventDiv.style.borderTopRightRadius = '0';
                                eventDiv.style.borderBottomRightRadius = '0';
                                widthAdd += 1; // å³å¢ƒç•Œç·šã‚’è¦†ã†
                            }

                            eventDiv.className = className;
                            eventDiv.setAttribute('data-event', JSON.stringify(event));
                            eventDiv.style.backgroundColor = event.color;
                            eventDiv.style.color = 'white';
                            eventDiv.style.fontWeight = '600';
                            eventDiv.style.cursor = 'pointer';
                            eventDiv.style.top = `${s * 26}px`; // ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã®é«˜ã•+ãƒãƒ¼ã‚¸ãƒ³ã«åˆã‚ã›ã‚‹
                            eventDiv.style.left = `${left}px`;
                            eventDiv.style.zIndex = '10';
                            
                            // å¹…ã®è¨­å®š (å¢ƒç•Œç·šã‚’è¦†ã†ãŸã‚ã«å°‘ã—åºƒã’ã‚‹)
                            // å·¦å³ã®é£Ÿã„è¾¼ã¿åˆ†ã‚’åŠ ç®—ã—ã¦ã€éš™é–“ã‚’ãªãã™
                            if (widthAdd > 0) {
                                // å¿µã®ãŸã‚ +1px ä½™åˆ†ã«è¿½åŠ ã—ã¦é‡ãªã‚Šã‚’ç¢ºå®Ÿã«ã™ã‚‹
                                eventDiv.style.width = `calc(100% + ${widthAdd + 1}px)`;
                            } else {
                                eventDiv.style.width = '100%';
                            }

                            // ãƒ†ã‚­ã‚¹ãƒˆè¡¨ç¤º (é–‹å§‹æ—¥ã¾ãŸã¯é€±ã®æœ€åˆ)
                            if (isStart || isWeekStart) {
                                eventDiv.textContent = event.summary;
                            } else {
                                eventDiv.innerHTML = '&nbsp;';
                            }
                            
                            dayEventsDiv.appendChild(eventDiv);
                        }
                    }

                    // 4. å˜æ—¥ã‚¤ãƒ™ãƒ³ãƒˆæç”»
                    const remainingSlots = 5 - (maxSlot + 1);
                    const displayedSingleDayEvents = singleDayEvents.slice(0, Math.max(0, remainingSlots));
                    
                    displayedSingleDayEvents.forEach(event => {
                        const time = event.allDay ? 'çµ‚æ—¥' : event.start.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
                        const eventDiv = document.createElement('div');
                        eventDiv.className = 'day-event';
                        eventDiv.setAttribute('data-event', JSON.stringify(event));
                        eventDiv.style.backgroundColor = event.color + '20';
                        eventDiv.style.color = event.color;
                        eventDiv.style.borderLeft = `3px solid ${event.color}`;
                        eventDiv.style.cursor = 'pointer';
                        eventDiv.title = event.summary;
                        eventDiv.textContent = time + ' ' + event.summary;
                        dayEventsDiv.appendChild(eventDiv);
                    });

                    // 5. ã€Œä»– X ä»¶ã€
                    const visibleMultiDayCount = currentSlots.filter(e => e !== null).length;
                    const hiddenMultiDayCount = multiDayEvents.length - visibleMultiDayCount;
                    const hiddenSingleDayCount = singleDayEvents.length - displayedSingleDayEvents.length;
                    const totalHidden = hiddenMultiDayCount + hiddenSingleDayCount;

                    if (totalHidden > 0) {
                        const allEvents = [...multiDayEvents, ...singleDayEvents];
                        const moreDiv = document.createElement('div');
                        moreDiv.className = 'text-xs text-blue-600 mt-1 cursor-pointer hover:underline';
                        moreDiv.style.position = 'relative';
                        moreDiv.style.zIndex = '20'; // ãƒãƒ¼ã‚ˆã‚Šä¸Šã«
                        moreDiv.setAttribute('data-date', currentDay.getTime());
                        moreDiv.setAttribute('data-all-events', JSON.stringify(allEvents));
                        moreDiv.textContent = `ä»– ${totalHidden} ä»¶`;
                        dayEventsDiv.appendChild(moreDiv);
                    }

                    dayDiv.appendChild(dayEventsDiv);
                    gridDiv.appendChild(dayDiv);
                }

                calendarDiv.appendChild(gridDiv);
                return calendarDiv.outerHTML;
            }

            attachEventListeners() {
                document.getElementById('today-btn')?.addEventListener('click', () => {
                    this.currentDate = new Date();
                    this.render();
                });

                document.getElementById('sync-btn')?.addEventListener('click', async () => {
                    const btn = document.getElementById('sync-btn');
                    const icon = document.getElementById('sync-icon');
                    btn.disabled = true;
                    btn.style.opacity = '0.5';
                    icon.classList.add('spinning');
                    await this.loadEvents();
                    icon.classList.remove('spinning');
                    this.render();
                    btn.disabled = false;
                    btn.style.opacity = '1';
                });

                document.getElementById('prev-btn')?.addEventListener('click', () => {
                    this.currentDate.setMonth(this.currentDate.getMonth() - 1);
                    this.render();
                });

                document.getElementById('next-btn')?.addEventListener('click', () => {
                    this.currentDate.setMonth(this.currentDate.getMonth() + 1);
                    this.render();
                });

                // ã‚¤ãƒ™ãƒ³ãƒˆã‚¯ãƒªãƒƒã‚¯æ™‚ã®è©³ç´°è¡¨ç¤º
                document.querySelectorAll('.day-event').forEach(el => {
                    el.addEventListener('click', (e) => {
                        const eventData = JSON.parse(e.currentTarget.getAttribute('data-event'));
                        this.showEventDetail(eventData);
                    });
                });

                // ã€Œä»– X ä»¶ã€ã‚¯ãƒªãƒƒã‚¯æ™‚ã®å…¨ã‚¤ãƒ™ãƒ³ãƒˆè¡¨ç¤º
                document.querySelectorAll('[data-all-events]').forEach(el => {
                    el.addEventListener('click', (e) => {
                        const allEvents = JSON.parse(e.currentTarget.getAttribute('data-all-events'));
                        const dateTime = parseInt(e.currentTarget.getAttribute('data-date'));
                        const date = new Date(dateTime);
                        this.showAllEventsModal(date, allEvents);
                    });
                });

                // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼åˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³
                document.querySelectorAll('.calendar-toggle').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const calendarName = e.currentTarget.getAttribute('data-calendar');
                        if (this.activeCalendars.has(calendarName)) {
                            this.activeCalendars.delete(calendarName);
                        } else {
                            this.activeCalendars.add(calendarName);
                        }
                        this.render();
                    });
                });
            }

            showEventDetail(event) {
                const formatDate = (date) => {
                    return new Date(date).toLocaleString('ja-JP', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        hour: event.allDay ? undefined : '2-digit',
                        minute: event.allDay ? undefined : '2-digit'
                    });
                };

                // çµ‚äº†æ—¥ã®è¡¨ç¤ºç”¨ï¼ˆçµ‚æ—¥ã‚¤ãƒ™ãƒ³ãƒˆã®å ´åˆã¯1æ—¥å¼•ãï¼‰
                const formatEndDate = (date) => {
                    const d = new Date(date);
                    if (event.allDay) {
                        d.setDate(d.getDate() - 1);
                    }
                    return formatDate(d);
                };

                const isMultiDay = event.end && (new Date(event.end).getTime() - new Date(event.start).getTime() > 86400000);

                const modal = document.createElement('div');
                modal.className = 'modal active';
                modal.innerHTML = `
                    <div class="modal-content">
                        <div class="flex items-start justify-between mb-4">
                            <h2 class="text-xl font-bold text-gray-800 flex-1">${event.summary}</h2>
                            <button class="modal-close text-gray-500 hover:text-gray-700">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                        <div class="space-y-3">
                            <div class="flex items-start">
                                <svg class="w-5 h-5 text-gray-500 mr-3 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                </svg>
                                <div>
                                    <div class="text-gray-700">${formatDate(event.start)}</div>
                                    ${event.end && (!event.allDay || isMultiDay) ? `<div class="text-gray-700">ã€œ ${formatEndDate(event.end)}</div>` : ''}
                                    ${event.allDay ? '<div class="text-sm text-gray-500">çµ‚æ—¥</div>' : ''}
                                </div>
                            </div>
                            ${event.location ? `
                                <div class="flex items-start">
                                    <svg class="w-5 h-5 text-gray-500 mr-3 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                    </svg>
                                    <div class="text-gray-700">${event.location}</div>
                                </div>
                            ` : ''}
                            ${event.description ? `
                                <div class="flex items-start">
                                    <svg class="w-5 h-5 text-gray-500 mr-3 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                                    </svg>
                                    <div class="text-gray-700 whitespace-pre-wrap">${event.description}</div>
                                </div>
                            ` : ''}
                            <div class="flex items-center">
                                <div class="w-4 h-4 rounded mr-3" style="background-color: ${event.color};"></div>
                                <div class="text-gray-700">${event.calendar}</div>
                            </div>
                        </div>
                    </div>
                `;

                document.body.appendChild(modal);

                const closeModal = () => {
                    modal.classList.remove('active');
                    setTimeout(() => modal.remove(), 200);
                };

                modal.addEventListener('click', (e) => {
                    if (e.target === modal) closeModal();
                });

                modal.querySelector('.modal-close')?.addEventListener('click', closeModal);
            }

            showAllEventsModal(date, events) {
                const formatDate = (date) => {
                    return new Date(date).toLocaleDateString('ja-JP', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                };

                const formatTime = (event) => {
                    if (event.allDay) return 'çµ‚æ—¥';
                    return new Date(event.start).toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
                };

                const modal = document.createElement('div');
                modal.className = 'modal active';
                
                let eventsHtml = '';
                events.forEach(event => {
                    eventsHtml += `
                        <div class="event-list-item p-3 border-l-4 mb-2 bg-gray-50 rounded cursor-pointer hover:bg-gray-100" 
                             style="border-color: ${event.color};" 
                             data-event='${JSON.stringify(event).replace(/'/g, "&#39;")}'>
                            <div class="flex items-start">
                                <div class="flex-1">
                                    <div class="font-semibold text-gray-800">${event.summary}</div>
                                    <div class="text-sm text-gray-600 mt-1">${formatTime(event)}</div>
                                    ${event.location ? `<div class="text-sm text-gray-500 mt-1">ğŸ“ ${event.location}</div>` : ''}
                                </div>
                                <div class="w-3 h-3 rounded-full ml-2" style="background-color: ${event.color};"></div>
                            </div>
                        </div>
                    `;
                });

                modal.innerHTML = `
                    <div class="modal-content">
                        <div class="flex items-start justify-between mb-4">
                            <h2 class="text-xl font-bold text-gray-800">${formatDate(date)} ã®äºˆå®š</h2>
                            <button class="modal-close text-gray-500 hover:text-gray-700">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                        <div class="text-sm text-gray-600 mb-3">å…¨ ${events.length} ä»¶ã®äºˆå®š</div>
                        <div class="space-y-2">
                            ${eventsHtml}
                        </div>
                    </div>
                `;

                document.body.appendChild(modal);

                const closeModal = () => {
                    modal.classList.remove('active');
                    setTimeout(() => modal.remove(), 200);
                };

                modal.addEventListener('click', (e) => {
                    if (e.target === modal) closeModal();
                });

                modal.querySelector('.modal-close')?.addEventListener('click', closeModal);

                // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒˆã‚¢ã‚¤ãƒ†ãƒ ã‚¯ãƒªãƒƒã‚¯ã§è©³ç´°è¡¨ç¤º
                modal.querySelectorAll('.event-list-item').forEach(el => {
                    el.addEventListener('click', (e) => {
                        const eventData = JSON.parse(e.currentTarget.getAttribute('data-event'));
                        closeModal();
                        this.showEventDetail(eventData);
                    });
                });
            }
        }

        // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³èµ·å‹•
        if (config.calendars.length > 0) {
            new CalendarApp();
        } else {
            document.getElementById('app').innerHTML = `
                <div class="flex items-center justify-center h-full">
                    <div class="text-center max-w-md">
                        <svg class="w-16 h-16 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                        <h2 class="text-xl font-semibold text-gray-800 mb-2">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“</h2>
                        <p class="text-gray-600">ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®è¨­å®šç”»é¢ã§Googleã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®iCal URLã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚</p>
                    </div>
                </div>
            `;
        }
    </script>
</body>
</html>
