<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Google„Ç´„É¨„É≥„ÉÄ„Éº„Éì„É•„Éº„ÉØ„Éº</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script>
        // Tailwind CDNË≠¶Âëä„ÇíÈùûË°®Á§∫
        window.process = { env: { NODE_ENV: 'production' } };
        
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        primary: '#4F46E5',
                        secondary: '#10B981',
                    }
                }
            }
        }
    </script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
        }
        
        /* „Ç´„Çπ„Çø„É†„Çπ„ÇØ„É≠„Éº„É´„Éê„Éº */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #c7c7c7;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        /* „Ç´„É¨„É≥„ÉÄ„Éº„Ç≥„É≥„ÉÜ„Éä */
        .calendar-container {
            width: 100%;
            height: 100vh;
            overflow: hidden;
        }

        /* „É≠„Éº„Éá„Ç£„É≥„Ç∞Ë°®Á§∫ */
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4F46E5;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* „Ç§„Éô„É≥„Éà„Ç´„Éº„Éâ */
        .event-card {
            border-left: 4px solid;
            transition: all 0.2s ease;
        }
        .event-card:hover {
            transform: translateX(2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        /* ÊúàË°®Á§∫„Ç´„É¨„É≥„ÉÄ„Éº */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, minmax(0, 1fr));
            gap: 0;
            width: 100%;
            border: 1px solid #e5e7eb;
        }

        .calendar-day {
            background: white;
            min-height: 100px;
            max-width: 100%;
            padding: 0;
            position: relative;
            overflow: visible;
            border-right: 1px solid #e5e7eb;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .calendar-day:nth-child(7n) {
            border-right: none;
        }

        .calendar-day.other-month {
            background: #f9fafb;
            color: #9ca3af;
        }

        .calendar-day.today {
            background: #eef2ff;
        }

        .day-number {
            font-weight: 600;
            padding: 8px 8px 4px 8px;
        }

        .day-events {
            font-size: 0.75rem;
            width: 100%;
            overflow: visible;
            padding-bottom: 4px;
        }

        .day-event {
            padding: 2px 4px;
            margin: 2px 4px;
            border-radius: 2px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            cursor: pointer;
            max-width: calc(100% - 8px);
            display: block;
        }

        .day-event:hover {
            opacity: 0.8;
        }

        .event-spanning {
            font-size: 0.7rem;
            padding: 2px 6px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            position: absolute;
            height: 22px;
            line-height: 18px;
            z-index: 10;
            border-radius: 3px;
            margin: 0;
            max-width: none;
        }
        
        .event-placeholder {
            height: 26px;
            margin: 2px 0;
            visibility: hidden;
        }

        /* ÂõûËª¢„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .spinning {
            animation: spin 1s linear infinite;
        }

        /* „É¢„Éº„ÉÄ„É´ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.2s;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: white;
            padding: 24px;
            border-radius: 8px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            animation: slideIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* „Ç¨„É≥„Éà„Éì„É•„ÉºÁî®„Çπ„Çø„Ç§„É´ */
        .gantt-container {
            display: flex;
            overflow: hidden;
            height: 100%;
            position: relative;
        }

        .gantt-sidebar {
            width: 250px;
            border-right: 1px solid #e5e7eb;
            overflow-y: hidden;
            overflow-x: hidden;
            background: white;
        }

        .gantt-chart {
            flex: 1;
            overflow-x: auto;
            overflow-y: auto;
            background: white;
        }
        
        .gantt-sidebar-header {
            position: sticky;
            top: 0;
            z-index: 20;
            background: #f9fafb;
        }
        
        .gantt-sidebar-content {
            overflow-y: hidden;
        }

        .gantt-header {
            display: flex;
            border-bottom: 2px solid #e5e7eb;
            position: sticky;
            top: 0;
            background: #f9fafb;
            z-index: 10;
            min-height: 60px;
        }

        .gantt-date-cell {
            min-width: 40px;
            padding: 8px 4px;
            text-align: center;
            border-right: 1px solid #e5e7eb;
            font-size: 0.75rem;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .gantt-date-cell.weekend {
            background: #fef3f2;
        }

        .gantt-date-cell.today {
            background: #eef2ff;
            font-weight: 600;
        }

        .gantt-row {
            display: flex;
            border-bottom: 1px solid #e5e7eb;
            min-height: 48px;
            align-items: center;
            position: relative;
        }

        .gantt-row:hover {
            background: #f9fafb;
        }

        .gantt-task-name {
            padding: 12px;
            border-bottom: 1px solid #e5e7eb;
            font-size: 0.875rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            min-height: 48px;
            display: flex;
            align-items: center;
        }

        .gantt-bar-container {
            position: relative;
            display: flex;
            align-items: center;
            height: 100%;
        }

        .gantt-bar {
            position: absolute;
            height: 28px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            padding: 0 8px;
            font-size: 0.75rem;
            color: white;
            font-weight: 500;
            overflow: visible;
            white-space: nowrap;
            z-index: 5;
        }

        .gantt-bar:hover {
            opacity: 0.8;
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 15;
        }
        
        .gantt-bar-label {
            position: absolute;
            left: 100%;
            margin-left: 8px;
            color: #374151;
            font-weight: 500;
            white-space: nowrap;
            pointer-events: none;
        }

        .gantt-grid-line {
            min-width: 40px;
            border-right: 1px solid #e5e7eb;
        }

        .gantt-grid-line.weekend {
            background: #fef3f2;
        }

        .gantt-grid-line.today {
            background: #eef2ff;
        }
    </style>
</head>
<body>
    <div id="app" class="calendar-container">
        <div class="flex items-center justify-center h-full">
            <div class="text-center">
                <div class="loading-spinner mx-auto mb-4"></div>
                <p class="text-gray-600">„Ç´„É¨„É≥„ÉÄ„Éº„ÇíË™≠„ÅøËæº„Çì„Åß„ÅÑ„Åæ„Åô...</p>
            </div>
        </div>
    </div>

    <div id="exment-calendar-config" style="display:none;" data-config='{"calendars":[],"syncInterval":15}'></div>
    <script>
        // „Ç∞„É≠„Éº„Éê„É´Ë®≠ÂÆöÔºàPHP„Åã„ÇâÊ≥®ÂÖ•„Åï„Çå„ÇãÔºâ
        let config = { calendars: [], syncInterval: 15 };
        try {
            const configDiv = document.getElementById('exment-calendar-config');
            if (configDiv) {
                const configAttr = configDiv.getAttribute('data-config');
                if (configAttr) {
                    console.log('Config attribute found, length:', configAttr.length);
                    config = JSON.parse(configAttr);
                    console.log('Config loaded successfully:', config);
                }
            }
        } catch (e) {
            console.error('Ë®≠ÂÆö„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:', e);
            console.error('Config attribute was:', document.getElementById('exment-calendar-config')?.getAttribute('data-config'));
            config = window.exmentGoogleCalendarConfig || { calendars: [], syncInterval: 15 };
        }

        // iCal„Éë„Éº„Çµ„Éº
        class ICalParser {
            static parse(icalData) {
                const events = [];
                const lines = icalData.split(/\r?\n/);
                let currentEvent = null;

                for (let i = 0; i < lines.length; i++) {
                    let line = lines[i].trim();

                    // Ë§áÊï∞Ë°å„ÅÆÁ∂ôÁ∂ö„ÇíÂá¶ÁêÜ
                    while (i + 1 < lines.length && lines[i + 1].match(/^[ \t]/)) {
                        i++;
                        line += lines[i].trim();
                    }

                    if (line === 'BEGIN:VEVENT') {
                        currentEvent = {};
                    } else if (line === 'END:VEVENT' && currentEvent) {
                        if (currentEvent.start && currentEvent.summary) {
                            events.push(currentEvent);
                        }
                        currentEvent = null;
                    } else if (currentEvent) {
                        const colonIndex = line.indexOf(':');
                        if (colonIndex > 0) {
                            const key = line.substring(0, colonIndex);
                            const value = line.substring(colonIndex + 1);

                            if (key.startsWith('DTSTART')) {
                                currentEvent.start = this.parseDate(value);
                                currentEvent.allDay = !value.includes('T');
                            } else if (key.startsWith('DTEND')) {
                                currentEvent.end = this.parseDate(value);
                            } else if (key === 'SUMMARY') {
                                currentEvent.summary = value;
                            } else if (key === 'DESCRIPTION') {
                                currentEvent.description = value;
                            } else if (key === 'LOCATION') {
                                currentEvent.location = value;
                            }
                        }
                    }
                }

                return events;
            }

            static parseDate(dateString) {
                // YYYYMMDD or YYYYMMDDTHHMMSSÂΩ¢Âºè
                const year = parseInt(dateString.substr(0, 4));
                const month = parseInt(dateString.substr(4, 2)) - 1;
                const day = parseInt(dateString.substr(6, 2));

                if (dateString.includes('T')) {
                    const hour = parseInt(dateString.substr(9, 2));
                    const minute = parseInt(dateString.substr(11, 2));
                    const second = parseInt(dateString.substr(13, 2));
                    return new Date(Date.UTC(year, month, day, hour, minute, second));
                }

                return new Date(year, month, day);
            }
        }

        // HTML„Ç®„Çπ„Ç±„Éº„ÉóÈñ¢Êï∞Ôºà„ÉÜ„É≥„Éó„É¨„Éº„Éà„É™„ÉÜ„É©„É´Áî®Ôºâ
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML
                .replace(/`/g, '&#96;')
                .replace(/\$/g, '&#36;')
                .replace(/\\/g, '&#92;');
        }

        // JSON „Çí HTML Â±ûÊÄßÁî®„Å´ÂÆâÂÖ®„Å´„Ç®„Çπ„Ç±„Éº„Éó
        function escapeJsonForAttribute(obj) {
            const json = JSON.stringify(obj);
            return json
                .replace(/&/g, '&amp;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/\n/g, '&#10;')
                .replace(/\r/g, '&#13;')
                .replace(/`/g, '&#96;')
                .replace(/\$/g, '&#36;');
        }

        // „Ç´„É¨„É≥„ÉÄ„Éº„Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥
        class CalendarApp {
            constructor() {
                this.events = [];
                this.currentDate = new Date();
                this.view = 'month'; // month, week, list
                this.activeCalendars = new Set(config.calendars.map(cal => cal.name));
                this.init();
            }

            async init() {
                await this.loadEvents();
                this.render();
                this.startAutoSync();
            }

            async loadEvents() {
                this.events = [];
                
                for (const calendar of config.calendars) {
                    try {
                        const proxyUrl = `${config.proxyUrl}?url=${encodeURIComponent(calendar.url)}`;
                        const response = await fetch(proxyUrl);
                        const icalData = await response.text();
                        const events = ICalParser.parse(icalData);
                        
                        events.forEach(event => {
                            event.calendar = calendar.name;
                            event.color = calendar.color;
                            this.events.push(event);
                        });
                    } catch (error) {
                        console.error(`„Ç´„É¨„É≥„ÉÄ„Éº ${calendar.name} „ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó:`, error);
                    }
                }

                this.events.sort((a, b) => a.start - b.start);
            }

            startAutoSync() {
                setInterval(() => {
                    this.loadEvents().then(() => this.render());
                }, config.syncInterval * 60 * 1000);
            }

            render() {
                const app = document.getElementById('app');
                
                let contentHtml = '';
                if (this.view === 'gantt') {
                    contentHtml = this.renderGanttView();
                } else {
                    contentHtml = this.renderCalendar();
                }
                
                app.innerHTML = `
                    <div class="h-full flex flex-col">
                        ${this.renderHeader()}
                        ${contentHtml}
                    </div>
                `;

                this.attachEventListeners();
            }

            renderHeader() {
                const monthNames = ['1Êúà', '2Êúà', '3Êúà', '4Êúà', '5Êúà', '6Êúà', '7Êúà', '8Êúà', '9Êúà', '10Êúà', '11Êúà', '12Êúà'];
                const currentMonth = monthNames[this.currentDate.getMonth()];
                const currentYear = this.currentDate.getFullYear();

                // „Ç´„É¨„É≥„ÉÄ„ÉºÈÅ∏Êäû„Éú„Çø„É≥
                let calendarButtons = '';
                config.calendars.forEach(cal => {
                    const isActive = this.activeCalendars ? this.activeCalendars.has(cal.name) : true;
                    calendarButtons += `
                        <button class="calendar-toggle px-3 py-1 rounded-full text-sm transition ${isActive ? 'opacity-100' : 'opacity-50'}" 
                                style="background-color: ${cal.color}20; color: ${cal.color}; border: 2px solid ${cal.color};" 
                                data-calendar="${cal.name}">
                            ${isActive ? '‚úì' : ''} ${cal.name}
                        </button>
                    `;
                });

                return `
                    <div class="bg-white border-b px-6 py-4">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center space-x-4">
                                <h1 class="text-2xl font-bold text-gray-800">${currentYear}Âπ¥ ${currentMonth}</h1>
                                <button id="sync-btn" class="px-4 py-2 bg-secondary text-white rounded-lg hover:bg-opacity-90 transition flex items-center space-x-2">
                                    <svg id="sync-icon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                    </svg>
                                    <span>ÂêåÊúü</span>
                                </button>
                            </div>
                            <div class="flex items-center space-x-2">
                                <!-- „Éì„É•„ÉºÂàá„ÇäÊõø„Åà„Éú„Çø„É≥ -->
                                <div class="bg-gray-100 rounded-lg p-1 flex mr-2">
                                    <button id="view-month-btn" class="px-3 py-1 rounded-md transition ${this.view === 'month' ? 'bg-white text-primary shadow-sm' : 'text-gray-600 hover:text-gray-800'}">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                        </svg>
                                    </button>
                                    <button id="view-gantt-btn" class="px-3 py-1 rounded-md transition ${this.view === 'gantt' ? 'bg-white text-primary shadow-sm' : 'text-gray-600 hover:text-gray-800'}">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                                        </svg>
                                    </button>
                                </div>
                                <button id="prev-btn" class="p-2 hover:bg-gray-100 rounded-lg transition">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                                    </svg>
                                </button>
                                <button id="today-btn" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-opacity-90 transition">‰ªäÊó•</button>
                                <button id="next-btn" class="p-2 hover:bg-gray-100 rounded-lg transition">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2 flex-wrap">
                            ${calendarButtons}
                        </div>
                    </div>
                `;
            }

            renderCalendar() {
                const year = this.currentDate.getFullYear();
                const month = this.currentDate.getMonth();
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const startDate = new Date(firstDay);
                startDate.setDate(startDate.getDate() - startDate.getDay());

                const days = ['Êó•', 'Êúà', 'ÁÅ´', 'Ê∞¥', 'Êú®', 'Èáë', 'Âúü'];
                
                // „Ç∞„É™„ÉÉ„Éâ„Ç≥„É≥„ÉÜ„Éä„Çí‰ΩúÊàê
                const calendarDiv = document.createElement('div');
                calendarDiv.className = 'flex-1 overflow-auto p-6';
                
                const gridDiv = document.createElement('div');
                gridDiv.className = 'calendar-grid';
                gridDiv.style.position = 'relative';

                // ÊõúÊó•„Éò„ÉÉ„ÉÄ„Éº
                days.forEach(day => {
                    const headerDiv = document.createElement('div');
                    headerDiv.className = 'bg-gray-100 p-2 text-center font-semibold';
                    headerDiv.textContent = day;
                    gridDiv.appendChild(headerDiv);
                });

                // „Ç´„É¨„É≥„ÉÄ„ÉºÊó•‰ªò
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                // „Çπ„É≠„ÉÉ„ÉàÁÆ°ÁêÜÁî® (ÊúÄÂ§ß5„Çπ„É≠„ÉÉ„Éà)
                let currentSlots = [null, null, null, null, null];

                for (let i = 0; i < 42; i++) {
                    const currentDay = new Date(startDate);
                    currentDay.setDate(currentDay.getDate() + i);
                    
                    const isOtherMonth = currentDay.getMonth() !== month;
                    const isToday = currentDay.getTime() === today.getTime();
                    
                    // „Åù„ÅÆÊó•„ÅÆ„Ç§„Éô„É≥„Éà„ÇíÂèñÂæó
                    const dayEvents = this.events.filter(event => {
                        if (!this.activeCalendars.has(event.calendar)) return false;
                        const eventStart = new Date(event.start);
                        eventStart.setHours(0, 0, 0, 0);
                        const eventEnd = event.end ? new Date(event.end) : new Date(event.start);
                        eventEnd.setHours(0, 0, 0, 0);
                        
                        // ÈñãÂßãÊó•„Åå‰ªäÊó•„ÄÅ„Åæ„Åü„ÅØÊúüÈñìÂÜÖ (ÁµÇ‰∫ÜÊó•„ÅØÂê´„Åæ„Å™„ÅÑ)
                        return (eventStart.getTime() === currentDay.getTime()) ||
                               (eventStart.getTime() < currentDay.getTime() && eventEnd.getTime() > currentDay.getTime());
                    });

                    // Ë§áÊï∞Êó•„Ç§„Éô„É≥„Éà„Å®ÂçòÊó•„Ç§„Éô„É≥„Éà„Å´ÂàÜÈõ¢
                    const multiDayEvents = [];
                    const singleDayEvents = [];

                    dayEvents.forEach(event => {
                        const eventStart = new Date(event.start);
                        eventStart.setHours(0, 0, 0, 0);
                        const eventEnd = event.end ? new Date(event.end) : new Date(event.start);
                        eventEnd.setHours(0, 0, 0, 0);
                        
                        if (eventEnd.getTime() > eventStart.getTime()) {
                            multiDayEvents.push(event);
                        } else {
                            singleDayEvents.push(event);
                        }
                    });

                    // 1. „Çπ„É≠„ÉÉ„Éà„ÅÆ„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó (ÁµÇ‰∫Ü„Åó„Åü„Ç§„Éô„É≥„Éà„ÇíÂâäÈô§)
                    currentSlots = currentSlots.map(event => {
                        if (!event) return null;
                        const eventEnd = event.end ? new Date(event.end) : new Date(event.start);
                        eventEnd.setHours(0, 0, 0, 0);
                        // ‰ªäÊó•„Åæ„Å†Á∂ö„ÅÑ„Å¶„ÅÑ„Çã„ÅãÔºü (ÁµÇ‰∫ÜÊó•„Åå‰ªäÊó•„Çà„ÇäÂæå„Å™„ÇâÁ∂ö„Åè)
                        if (eventEnd.getTime() > currentDay.getTime()) {
                            return event;
                        }
                        return null;
                    });

                    // 2. Êñ∞„Åó„ÅÑË§áÊï∞Êó•„Ç§„Éô„É≥„Éà„ÇíÁ©∫„Åç„Çπ„É≠„ÉÉ„Éà„Å´Ââ≤„ÇäÂΩì„Å¶
                    const startingMultiDayEvents = multiDayEvents.filter(event => {
                        const eventStart = new Date(event.start);
                        eventStart.setHours(0, 0, 0, 0);
                        
                        // ÈñãÂßãÊó•„Åå‰ªäÊó•„ÅÆÂ†¥Âêà
                        if (eventStart.getTime() === currentDay.getTime()) return true;
                        
                        // „Åæ„Åü„ÅØ„ÄÅ„Ç∞„É™„ÉÉ„Éâ„ÅÆÊúÄÂàù„ÅÆÊó•(i===0)„Åß„ÄÅ„Åã„Å§Êó¢„Å´ÈñãÂßã„Åó„Å¶„ÅÑ„ÇãÂ†¥ÂêàÔºàÂâçÊúà„Åã„Çâ„ÅÆÁ∂ôÁ∂ö„Å™„Å©Ôºâ
                        if (i === 0 && eventStart.getTime() < currentDay.getTime()) return true;
                        
                        return false;
                    });
                    
                    // „ÇΩ„Éº„Éà (ÊúüÈñì„ÅåÈï∑„ÅÑÈ†Ü„ÄÅÈñãÂßãÊó•ÊôÇÈ†Ü)
                    startingMultiDayEvents.sort((a, b) => {
                        const durationA = (a.end ? new Date(a.end).getTime() : new Date(a.start).getTime()) - new Date(a.start).getTime();
                        const durationB = (b.end ? new Date(b.end).getTime() : new Date(b.start).getTime()) - new Date(b.start).getTime();
                        
                        // ÊúüÈñì„ÅåÈï∑„ÅÑÈ†Ü
                        if (durationA !== durationB) {
                            return durationB - durationA;
                        }
                        // ÈñãÂßãÊó•ÊôÇÈ†Ü
                        return new Date(a.start).getTime() - new Date(b.start).getTime();
                    });

                    startingMultiDayEvents.forEach(event => {
                        // Êó¢„Å´„Çπ„É≠„ÉÉ„Éà„Å´„ÅÇ„Çã„ÅãÁ¢∫Ë™çÔºàÈáçË§áÈò≤Ê≠¢Ôºâ
                        if (currentSlots.includes(event)) return;

                        const emptyIndex = currentSlots.indexOf(null);
                        if (emptyIndex !== -1) {
                            currentSlots[emptyIndex] = event;
                        }
                    });

                    // DOMÁîüÊàê
                    let dayClass = 'calendar-day';
                    if (isOtherMonth) dayClass += ' other-month';
                    if (isToday) dayClass += ' today';

                    const dayDiv = document.createElement('div');
                    dayDiv.className = dayClass;
                    
                    const dayNumber = document.createElement('div');
                    dayNumber.className = 'day-number';
                    dayNumber.textContent = currentDay.getDate();
                    dayDiv.appendChild(dayNumber);
                    
                    const dayEventsDiv = document.createElement('div');
                    dayEventsDiv.className = 'day-events';
                    dayEventsDiv.style.position = 'relative';

                    // 3. „Çπ„É≠„ÉÉ„Éà„ÅÆÊèèÁîª
                    // ÊúÄÂ§ß„Çπ„É≠„ÉÉ„Éà„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ„ÇíÁâπÂÆö
                    let maxSlot = -1;
                    for (let s = 4; s >= 0; s--) {
                        if (currentSlots[s]) {
                            maxSlot = s;
                            break;
                        }
                    }

                    for (let s = 0; s <= maxSlot; s++) {
                        const event = currentSlots[s];
                        
                        // „Éó„É¨„Éº„Çπ„Éõ„É´„ÉÄ„Éº (È´ò„ÅïÁ¢∫‰øù)
                        const placeholder = document.createElement('div');
                        placeholder.style.height = '24px';
                        placeholder.style.marginBottom = '2px';
                        placeholder.style.visibility = 'hidden'; // Â∏∏„Å´ÈùûË°®Á§∫Ôºà„Çπ„Éö„Éº„ÇπÁ¢∫‰øù„ÅÆ„ÅøÔºâ
                        dayEventsDiv.appendChild(placeholder);

                        if (event) {
                            const eventStart = new Date(event.start);
                            eventStart.setHours(0, 0, 0, 0);
                            const eventEnd = event.end ? new Date(event.end) : new Date(event.start);
                            eventEnd.setHours(0, 0, 0, 0);

                            const isStart = eventStart.getTime() === currentDay.getTime();
                            const dayOfWeek = currentDay.getDay();
                            const isWeekStart = dayOfWeek === 0;
                            const isWeekEnd = dayOfWeek === 6;

                            // „Éê„Éº„ÇíÊèèÁîª (ÂêÑÊó•„Å´„Çª„Ç∞„É°„É≥„Éà„Å®„Åó„Å¶ÊèèÁîª)
                            const eventDiv = document.createElement('div');
                            let className = 'day-event event-spanning';
                            
                            // Á∂ôÁ∂öÁä∂ÊÖã„ÅÆÂà§ÂÆö
                            const nextDay = new Date(currentDay);
                            nextDay.setDate(nextDay.getDate() + 1);

                            const continuesLeft = !isStart && !isWeekStart;
                            const continuesRight = (eventEnd.getTime() > nextDay.getTime()) && !isWeekEnd;

                            // „Çπ„Çø„Ç§„É´Ë™øÊï¥
                            let left = 0;
                            let widthAdd = 0;
                            
                            // „Éû„Éº„Ç∏„É≥„Å®ÊúÄÂ§ßÂπÖ„ÅÆ„É™„Çª„ÉÉ„Éà„ÅØCSS„ÅßË°å„Å£„Å¶„ÅÑ„Çã„Åå„ÄÅÂøµ„ÅÆ„Åü„ÇÅ„Çπ„Çø„Ç§„É´„Åß„ÇÇÊòéÁ§∫
                            eventDiv.style.margin = '0';
                            eventDiv.style.maxWidth = 'none';

                            if (continuesLeft) {
                                eventDiv.style.borderTopLeftRadius = '0';
                                eventDiv.style.borderBottomLeftRadius = '0';
                                left -= 1; // Â∑¶Â¢ÉÁïåÁ∑ö„ÇíË¶Ü„ÅÜ
                                widthAdd += 1;
                            }

                            if (continuesRight) {
                                eventDiv.style.borderTopRightRadius = '0';
                                eventDiv.style.borderBottomRightRadius = '0';
                                widthAdd += 1; // Âè≥Â¢ÉÁïåÁ∑ö„ÇíË¶Ü„ÅÜ
                            }

                            eventDiv.className = className;
                            eventDiv.setAttribute('data-event', JSON.stringify(event));
                            eventDiv.style.backgroundColor = event.color;
                            eventDiv.style.color = 'white';
                            eventDiv.style.fontWeight = '600';
                            eventDiv.style.cursor = 'pointer';
                            eventDiv.style.top = `${s * 26}px`; // „Éó„É¨„Éº„Çπ„Éõ„É´„ÉÄ„Éº„ÅÆÈ´ò„Åï+„Éû„Éº„Ç∏„É≥„Å´Âêà„Çè„Åõ„Çã
                            eventDiv.style.left = `${left}px`;
                            eventDiv.style.zIndex = '10';
                            
                            // ÂπÖ„ÅÆË®≠ÂÆö (Â¢ÉÁïåÁ∑ö„ÇíË¶Ü„ÅÜ„Åü„ÇÅ„Å´Â∞ë„ÅóÂ∫É„Åí„Çã)
                            // Â∑¶Âè≥„ÅÆÈ£ü„ÅÑËæº„ÅøÂàÜ„ÇíÂä†ÁÆó„Åó„Å¶„ÄÅÈöôÈñì„Çí„Å™„Åè„Åô
                            if (widthAdd > 0) {
                                // Âøµ„ÅÆ„Åü„ÇÅ +1px ‰ΩôÂàÜ„Å´ËøΩÂä†„Åó„Å¶Èáç„Å™„Çä„ÇíÁ¢∫ÂÆü„Å´„Åô„Çã
                                eventDiv.style.width = `calc(100% + ${widthAdd + 1}px)`;
                            } else {
                                eventDiv.style.width = '100%';
                            }

                            // „ÉÜ„Ç≠„Çπ„ÉàË°®Á§∫ (ÈñãÂßãÊó•„Åæ„Åü„ÅØÈÄ±„ÅÆÊúÄÂàù)
                            if (isStart || isWeekStart) {
                                eventDiv.textContent = event.summary;
                            } else {
                                eventDiv.innerHTML = '&nbsp;';
                            }
                            
                            dayEventsDiv.appendChild(eventDiv);
                        }
                    }

                    // 4. ÂçòÊó•„Ç§„Éô„É≥„ÉàÊèèÁîª
                    const remainingSlots = 5 - (maxSlot + 1);
                    const displayedSingleDayEvents = singleDayEvents.slice(0, Math.max(0, remainingSlots));
                    
                    displayedSingleDayEvents.forEach(event => {
                        const time = event.allDay ? 'ÁµÇÊó•' : event.start.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
                        const eventDiv = document.createElement('div');
                        eventDiv.className = 'day-event';
                        eventDiv.setAttribute('data-event', JSON.stringify(event));
                        eventDiv.style.backgroundColor = event.color + '20';
                        eventDiv.style.color = event.color;
                        eventDiv.style.borderLeft = `3px solid ${event.color}`;
                        eventDiv.style.cursor = 'pointer';
                        eventDiv.title = event.summary;
                        eventDiv.textContent = time + ' ' + event.summary;
                        dayEventsDiv.appendChild(eventDiv);
                    });

                    // 5. „Äå‰ªñ X ‰ª∂„Äç
                    const visibleMultiDayCount = currentSlots.filter(e => e !== null).length;
                    const hiddenMultiDayCount = multiDayEvents.length - visibleMultiDayCount;
                    const hiddenSingleDayCount = singleDayEvents.length - displayedSingleDayEvents.length;
                    const totalHidden = hiddenMultiDayCount + hiddenSingleDayCount;

                    if (totalHidden > 0) {
                        const allEvents = [...multiDayEvents, ...singleDayEvents];
                        const moreDiv = document.createElement('div');
                        moreDiv.className = 'text-xs text-blue-600 mt-1 cursor-pointer hover:underline';
                        moreDiv.style.position = 'relative';
                        moreDiv.style.zIndex = '20'; // „Éê„Éº„Çà„Çä‰∏ä„Å´
                        moreDiv.setAttribute('data-date', currentDay.getTime());
                        moreDiv.setAttribute('data-all-events', JSON.stringify(allEvents));
                        moreDiv.textContent = `‰ªñ ${totalHidden} ‰ª∂`;
                        dayEventsDiv.appendChild(moreDiv);
                    }

                    dayDiv.appendChild(dayEventsDiv);
                    gridDiv.appendChild(dayDiv);
                }

                calendarDiv.appendChild(gridDiv);
                return calendarDiv.outerHTML;
            }

            attachEventListeners() {
                document.getElementById('today-btn')?.addEventListener('click', () => {
                    this.currentDate = new Date();
                    this.render();
                });

                document.getElementById('sync-btn')?.addEventListener('click', async () => {
                    const btn = document.getElementById('sync-btn');
                    const icon = document.getElementById('sync-icon');
                    btn.disabled = true;
                    btn.style.opacity = '0.5';
                    icon.classList.add('spinning');
                    await this.loadEvents();
                    icon.classList.remove('spinning');
                    this.render();
                    btn.disabled = false;
                    btn.style.opacity = '1';
                });

                document.getElementById('prev-btn')?.addEventListener('click', () => {
                    this.currentDate.setMonth(this.currentDate.getMonth() - 1);
                    this.render();
                });

                document.getElementById('next-btn')?.addEventListener('click', () => {
                    this.currentDate.setMonth(this.currentDate.getMonth() + 1);
                    this.render();
                });

                // „Éì„É•„ÉºÂàá„ÇäÊõø„Åà„Éú„Çø„É≥
                document.getElementById('view-month-btn')?.addEventListener('click', () => {
                    this.view = 'month';
                    this.render();
                });

                document.getElementById('view-gantt-btn')?.addEventListener('click', () => {
                    this.view = 'gantt';
                    this.render();
                });

                // „Ç§„Éô„É≥„Éà„ÇØ„É™„ÉÉ„ÇØÊôÇ„ÅÆË©≥Á¥∞Ë°®Á§∫Ôºà„Ç´„É¨„É≥„ÉÄ„Éº„Éì„É•„ÉºÔºâ
                document.querySelectorAll('.day-event').forEach(el => {
                    el.addEventListener('click', (e) => {
                        const eventData = JSON.parse(e.currentTarget.getAttribute('data-event'));
                        this.showEventDetail(eventData);
                    });
                });

                // „Ç¨„É≥„Éà„Éê„Éº„ÇØ„É™„ÉÉ„ÇØÊôÇ„ÅÆË©≥Á¥∞Ë°®Á§∫
                document.querySelectorAll('.gantt-bar').forEach(el => {
                    el.addEventListener('click', (e) => {
                        const eventData = JSON.parse(e.currentTarget.getAttribute('data-event'));
                        this.showEventDetail(eventData);
                    });
                });

                // „Äå‰ªñ X ‰ª∂„Äç„ÇØ„É™„ÉÉ„ÇØÊôÇ„ÅÆÂÖ®„Ç§„Éô„É≥„ÉàË°®Á§∫
                document.querySelectorAll('[data-all-events]').forEach(el => {
                    el.addEventListener('click', (e) => {
                        const allEvents = JSON.parse(e.currentTarget.getAttribute('data-all-events'));
                        const dateTime = parseInt(e.currentTarget.getAttribute('data-date'));
                        const date = new Date(dateTime);
                        this.showAllEventsModal(date, allEvents);
                    });
                });

                // „Ç´„É¨„É≥„ÉÄ„ÉºÂàá„ÇäÊõø„Åà„Éú„Çø„É≥
                document.querySelectorAll('.calendar-toggle').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const calendarName = e.currentTarget.getAttribute('data-calendar');
                        if (this.activeCalendars.has(calendarName)) {
                            this.activeCalendars.delete(calendarName);
                        } else {
                            this.activeCalendars.add(calendarName);
                        }
                        this.render();
                    });
                });

                // „Ç¨„É≥„Éà„ÉÅ„É£„Éº„Éà„ÅÆ„Çπ„ÇØ„É≠„Éº„É´ÈÄ£Âãï
                const ganttChart = document.getElementById('gantt-chart');
                const ganttSidebarContent = document.getElementById('gantt-sidebar-content');
                
                if (ganttChart && ganttSidebarContent) {
                    ganttChart.addEventListener('scroll', () => {
                        ganttSidebarContent.style.transform = `translateY(-${ganttChart.scrollTop}px)`;
                    });
                }
            }

            showEventDetail(event) {
                const formatDate = (date) => {
                    return new Date(date).toLocaleString('ja-JP', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        hour: event.allDay ? undefined : '2-digit',
                        minute: event.allDay ? undefined : '2-digit'
                    });
                };

                // ÁµÇ‰∫ÜÊó•„ÅÆË°®Á§∫Áî®ÔºàÁµÇÊó•„Ç§„Éô„É≥„Éà„ÅÆÂ†¥Âêà„ÅØ1Êó•Âºï„ÅèÔºâ
                const formatEndDate = (date) => {
                    const d = new Date(date);
                    if (event.allDay) {
                        d.setDate(d.getDate() - 1);
                    }
                    return formatDate(d);
                };

                const isMultiDay = event.end && (new Date(event.end).getTime() - new Date(event.start).getTime() > 86400000);

                const modal = document.createElement('div');
                modal.className = 'modal active';
                modal.innerHTML = `
                    <div class="modal-content">
                        <div class="flex items-start justify-between mb-4">
                            <h2 class="text-xl font-bold text-gray-800 flex-1">${event.summary}</h2>
                            <button class="modal-close text-gray-500 hover:text-gray-700">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                        <div class="space-y-3">
                            <div class="flex items-start">
                                <svg class="w-5 h-5 text-gray-500 mr-3 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                </svg>
                                <div>
                                    <div class="text-gray-700">${formatDate(event.start)}</div>
                                    ${event.end && (!event.allDay || isMultiDay) ? `<div class="text-gray-700">„Äú ${formatEndDate(event.end)}</div>` : ''}
                                    ${event.allDay ? '<div class="text-sm text-gray-500">ÁµÇÊó•</div>' : ''}
                                </div>
                            </div>
                            ${event.location ? `
                                <div class="flex items-start">
                                    <svg class="w-5 h-5 text-gray-500 mr-3 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                    </svg>
                                    <div class="text-gray-700">${event.location}</div>
                                </div>
                            ` : ''}
                            ${event.description ? `
                                <div class="flex items-start">
                                    <svg class="w-5 h-5 text-gray-500 mr-3 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                                    </svg>
                                    <div class="text-gray-700 whitespace-pre-wrap">${event.description}</div>
                                </div>
                            ` : ''}
                            <div class="flex items-center">
                                <div class="w-4 h-4 rounded mr-3" style="background-color: ${event.color};"></div>
                                <div class="text-gray-700">${event.calendar}</div>
                            </div>
                        </div>
                    </div>
                `;

                document.body.appendChild(modal);

                const closeModal = () => {
                    modal.classList.remove('active');
                    setTimeout(() => modal.remove(), 200);
                };

                modal.addEventListener('click', (e) => {
                    if (e.target === modal) closeModal();
                });

                modal.querySelector('.modal-close')?.addEventListener('click', closeModal);
            }

            showAllEventsModal(date, events) {
                const formatDate = (date) => {
                    return new Date(date).toLocaleDateString('ja-JP', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                };

                const formatTime = (event) => {
                    if (event.allDay) return 'ÁµÇÊó•';
                    return new Date(event.start).toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
                };

                const modal = document.createElement('div');
                modal.className = 'modal active';
                
                let eventsHtml = '';
                events.forEach(event => {
                    eventsHtml += `
                        <div class="event-list-item p-3 border-l-4 mb-2 bg-gray-50 rounded cursor-pointer hover:bg-gray-100" 
                             style="border-color: ${event.color};" 
                             data-event='${JSON.stringify(event).replace(/'/g, "&#39;")}'>
                            <div class="flex items-start">
                                <div class="flex-1">
                                    <div class="font-semibold text-gray-800">${event.summary}</div>
                                    <div class="text-sm text-gray-600 mt-1">${formatTime(event)}</div>
                                    ${event.location ? `<div class="text-sm text-gray-500 mt-1">üìç ${event.location}</div>` : ''}
                                </div>
                                <div class="w-3 h-3 rounded-full ml-2" style="background-color: ${event.color};"></div>
                            </div>
                        </div>
                    `;
                });

                modal.innerHTML = `
                    <div class="modal-content">
                        <div class="flex items-start justify-between mb-4">
                            <h2 class="text-xl font-bold text-gray-800">${formatDate(date)} „ÅÆ‰∫àÂÆö</h2>
                            <button class="modal-close text-gray-500 hover:text-gray-700">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                        <div class="text-sm text-gray-600 mb-3">ÂÖ® ${events.length} ‰ª∂„ÅÆ‰∫àÂÆö</div>
                        <div class="space-y-2">
                            ${eventsHtml}
                        </div>
                    </div>
                `;

                document.body.appendChild(modal);

                const closeModal = () => {
                    modal.classList.remove('active');
                    setTimeout(() => modal.remove(), 200);
                };

                modal.addEventListener('click', (e) => {
                    if (e.target === modal) closeModal();
                });

                modal.querySelector('.modal-close')?.addEventListener('click', closeModal);

                // „Ç§„Éô„É≥„Éà„É™„Çπ„Éà„Ç¢„Ç§„ÉÜ„É†„ÇØ„É™„ÉÉ„ÇØ„ÅßË©≥Á¥∞Ë°®Á§∫
                modal.querySelectorAll('.event-list-item').forEach(el => {
                    el.addEventListener('click', (e) => {
                        const eventData = JSON.parse(e.currentTarget.getAttribute('data-event'));
                        closeModal();
                        this.showEventDetail(eventData);
                    });
                });
            }

            renderGanttView() {
                // Ë°®Á§∫ÊúüÈñì„ÇíÂèñÂæóÔºàÂΩìÊúà„ÅÆ1Êó•„Åã„ÇâÊú´Êó•„Åæ„ÅßÔºâ
                const year = this.currentDate.getFullYear();
                const month = this.currentDate.getMonth();
                const firstDay = new Date(year, month, 1);
                firstDay.setHours(0, 0, 0, 0);
                const lastDay = new Date(year, month + 1, 0);
                lastDay.setHours(23, 59, 59, 999);
                
                // „Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å™„Ç´„É¨„É≥„ÉÄ„Éº„ÅÆ„Ç§„Éô„É≥„Éà„Åß„ÄÅ„Åã„Å§ÂΩìÊúà„Å´Èñ¢‰øÇ„Åô„Çã„ÇÇ„ÅÆ„ÅÆ„Åø„Çí„Éï„Ç£„É´„Çø
                const filteredEvents = this.events.filter(event => {
                    if (!this.activeCalendars.has(event.calendar)) {
                        return false;
                    }
                    
                    const eventStart = new Date(event.start);
                    eventStart.setHours(0, 0, 0, 0);
                    let eventEnd = event.end ? new Date(event.end) : new Date(event.start);
                    eventEnd.setHours(0, 0, 0, 0);
                    
                    // ÁµÇÊó•„Ç§„Éô„É≥„Éà„ÅÆÁµÇ‰∫ÜÊó•Ë™øÊï¥ÔºàÁµÇ‰∫ÜÊó•„ÅØÂê´„Åæ„Å™„ÅÑÔºâ
                    if (event.allDay && event.end) {
                        eventEnd.setDate(eventEnd.getDate() - 1);
                    }
                    
                    // „Ç§„Éô„É≥„Éà„ÅåÂΩìÊúà„Å´Èáç„Å™„Å£„Å¶„ÅÑ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
                    // „Ç§„Éô„É≥„ÉàÈñãÂßã„ÅåÊúàÊú´‰ª•Ââç „Åã„Å§ „Ç§„Éô„É≥„ÉàÁµÇ‰∫Ü„ÅåÊúàÂàù‰ª•Èôç
                    const monthStart = new Date(year, month, 1);
                    monthStart.setHours(0, 0, 0, 0);
                    const monthEnd = new Date(year, month + 1, 0);
                    monthEnd.setHours(23, 59, 59, 999);
                    
                    return eventStart <= monthEnd && eventEnd >= monthStart;
                });
                
                // Êó•‰ªò„Éò„ÉÉ„ÉÄ„Éº„ÇíÁîüÊàê
                const days = [];
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                for (let d = new Date(firstDay); d <= lastDay; d.setDate(d.getDate() + 1)) {
                    const dayOfWeek = d.getDay();
                    const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                    const isToday = d.getTime() === today.getTime();
                    
                    days.push({
                        date: new Date(d),
                        day: d.getDate(),
                        isWeekend,
                        isToday
                    });
                }
                
                // „Éò„ÉÉ„ÉÄ„ÉºÁîüÊàê
                const dayOfWeekNames = ['Êó•', 'Êúà', 'ÁÅ´', 'Ê∞¥', 'Êú®', 'Èáë', 'Âúü'];
                let headerHtml = '<div class="gantt-header">';
                days.forEach(dayInfo => {
                    let className = 'gantt-date-cell';
                    if (dayInfo.isWeekend) className += ' weekend';
                    if (dayInfo.isToday) className += ' today';
                    
                    const dayOfWeekName = dayOfWeekNames[dayInfo.date.getDay()];
                    headerHtml += `
                        <div class="${className}">
                            <div style="font-weight: 600;">${dayInfo.day}</div>
                            <div style="font-size: 0.65rem; margin-top: 2px;">${dayOfWeekName}</div>
                        </div>
                    `;
                });
                headerHtml += '</div>';
                
                // „Çø„Çπ„ÇØË°å„ÇíÁîüÊàê
                let tasksHtml = '';
                let sidebarHtml = '';
                
                filteredEvents.forEach(event => {
                    const eventStart = new Date(event.start);
                    eventStart.setHours(0, 0, 0, 0);
                    const eventEnd = event.end ? new Date(event.end) : new Date(event.start);
                    eventEnd.setHours(0, 0, 0, 0);
                    
                    // ÁµÇÊó•„Ç§„Éô„É≥„Éà„ÅÆÁµÇ‰∫ÜÊó•Ë™øÊï¥ÔºàÁµÇ‰∫ÜÊó•„ÅØÂê´„Åæ„Å™„ÅÑÔºâ
                    if (event.allDay && event.end) {
                        eventEnd.setDate(eventEnd.getDate() - 1);
                    }
                    
                    // „Çµ„Ç§„Éâ„Éê„ÉºÔºà„Çø„Çπ„ÇØÂêçÔºâ
                    sidebarHtml += `
                        <div class="gantt-task-name" title="${event.summary}">
                            <div class="w-3 h-3 rounded-full mr-2" style="background-color: ${event.color};"></div>
                            <span class="flex-1">${event.summary}</span>
                        </div>
                    `;
                    
                    // „Ç∞„É™„ÉÉ„ÉâË°å„Å®„Éê„Éº
                    tasksHtml += '<div class="gantt-row">';
                    
                    let barHtml = '';
                    let barStartIndex = -1;
                    let barWidth = 0;
                    
                    days.forEach((dayInfo, index) => {
                        const dayDate = new Date(dayInfo.date);
                        
                        // „Ç∞„É™„ÉÉ„ÉâÁ∑ö
                        let gridClass = 'gantt-grid-line';
                        if (dayInfo.isWeekend) gridClass += ' weekend';
                        if (dayInfo.isToday) gridClass += ' today';
                        
                        tasksHtml += `<div class="${gridClass}"></div>`;
                        
                        // „Éê„Éº„ÅÆÈñãÂßã‰ΩçÁΩÆ„Å®ÂπÖ„ÇíË®àÁÆó
                        if (dayDate.getTime() >= eventStart.getTime() && 
                            dayDate.getTime() <= eventEnd.getTime()) {
                            if (barStartIndex === -1) {
                                barStartIndex = index;
                            }
                            barWidth++;
                        }
                    });
                    
                    // „Éê„Éº„ÇíÊèèÁîª
                    if (barStartIndex !== -1 && barWidth > 0) {
                        const leftPosition = barStartIndex * 40 + 2; // 2px „ÅÆ„Éû„Éº„Ç∏„É≥
                        const barWidthPx = barWidth * 40 - 4; // Â∑¶Âè≥2px„Åö„Å§„ÅÆ„Éû„Éº„Ç∏„É≥
                        
                        barHtml = `
                            <div class="gantt-bar" 
                                 style="left: ${leftPosition}px; width: ${barWidthPx}px; background-color: ${event.color};"
                                 data-event='${JSON.stringify(event).replace(/'/g, "&#39;")}'>
                                <span class="gantt-bar-label">${event.summary}</span>
                            </div>
                        `;
                        
                        tasksHtml += barHtml;
                    }
                    
                    tasksHtml += '</div>';
                });
                
                const ganttDiv = document.createElement('div');
                ganttDiv.className = 'flex-1 overflow-hidden';
                ganttDiv.innerHTML = `
                    <div class="gantt-container">
                        <div class="gantt-sidebar" id="gantt-sidebar">
                            <div class="gantt-sidebar-header bg-gray-100 p-3 text-sm font-semibold border-b" style="min-height: 60px; display: flex; align-items: center;">
                                „Çø„Çπ„ÇØÂêç
                            </div>
                            <div class="gantt-sidebar-content" id="gantt-sidebar-content">
                                ${sidebarHtml}
                            </div>
                        </div>
                        <div class="gantt-chart" id="gantt-chart">
                            ${headerHtml}
                            ${tasksHtml}
                        </div>
                    </div>
                `;
                
                return ganttDiv.outerHTML;
            }
        }

        // „Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥Ëµ∑Âãï
        if (config.calendars.length > 0) {
            new CalendarApp();
        } else {
            document.getElementById('app').innerHTML = `
                <div class="flex items-center justify-center h-full">
                    <div class="text-center max-w-md">
                        <svg class="w-16 h-16 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                        <h2 class="text-xl font-semibold text-gray-800 mb-2">„Ç´„É¨„É≥„ÉÄ„Éº„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì</h2>
                        <p class="text-gray-600">„Éó„É©„Ç∞„Ç§„É≥„ÅÆË®≠ÂÆöÁîªÈù¢„ÅßGoogle„Ç´„É¨„É≥„ÉÄ„Éº„ÅÆiCal URL„ÇíË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</p>
                    </div>
                </div>
            `;
        }
    </script>
</body>
</html>
